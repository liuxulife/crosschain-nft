# Aderyn Analysis Report

This report was generated by [Aderyn](https://github.com/Cyfrin/aderyn), a static analysis tool built by [Cyfrin](https://cyfrin.io), a blockchain security company. This report is not a substitute for manual audit or security review. It should not be relied upon for any purpose other than to assist in the identification of potential security vulnerabilities.
# Table of Contents

- [Aderyn Analysis Report](#aderyn-analysis-report)
- [Table of Contents](#table-of-contents)
- [Summary](#summary)
	- [Files Summary](#files-summary)
	- [Files Details](#files-details)
	- [Issue Summary](#issue-summary)
- [High Issues](#high-issues)
	- [H-1: `abi.encodePacked()` should not be used with dynamic types when passing the result to a hash function such as `keccak256()`](#h-1-abiencodepacked-should-not-be-used-with-dynamic-types-when-passing-the-result-to-a-hash-function-such-as-keccak256)
	- [H-2: Functions send eth away from contract but performs no checks on any address.](#h-2-functions-send-eth-away-from-contract-but-performs-no-checks-on-any-address)
- [Low Issues](#low-issues)
	- [L-1: Centralization Risk for trusted owners](#l-1-centralization-risk-for-trusted-owners)
	- [L-2: Unsafe ERC20 Operations should not be used](#l-2-unsafe-erc20-operations-should-not-be-used)
	- [L-3: Missing checks for `address(0)` when assigning values to address state variables](#l-3-missing-checks-for-address0-when-assigning-values-to-address-state-variables)
	- [L-4: `public` functions not used internally could be marked `external`](#l-4-public-functions-not-used-internally-could-be-marked-external)
	- [L-5: Event is missing `indexed` fields](#l-5-event-is-missing-indexed-fields)
	- [L-6: Modifiers invoked only once can be shoe-horned into the function](#l-6-modifiers-invoked-only-once-can-be-shoe-horned-into-the-function)
	- [L-7: Large literal values multiples of 10000 can be replaced with scientific notation](#l-7-large-literal-values-multiples-of-10000-can-be-replaced-with-scientific-notation)
	- [L-8: Internal functions called only once can be inlined](#l-8-internal-functions-called-only-once-can-be-inlined)
	- [L-9: State variable changes but no event is emitted.](#l-9-state-variable-changes-but-no-event-is-emitted)
	- [L-10: State variable could be declared immutable](#l-10-state-variable-could-be-declared-immutable)
	- [L-11: Return value of the function call is not checked.](#l-11-return-value-of-the-function-call-is-not-checked)


# Summary

## Files Summary

| Key | Value |
| --- | --- |
| .sol Files | 4 |
| Total nSLOC | 419 |


## Files Details

| Filepath | nSLOC |
| --- | --- |
| src/MNftPoolLockAndRelease.sol | 169 |
| src/MoodNft.sol | 76 |
| src/WMNftPoolMintAndBurn.sol | 157 |
| src/WMoodNft.sol | 17 |
| **Total** | **419** |


## Issue Summary

| Category | No. of Issues |
| --- | --- |
| High | 2 |
| Low | 11 |


# High Issues

## H-1: `abi.encodePacked()` should not be used with dynamic types when passing the result to a hash function such as `keccak256()`

Use `abi.encode()` instead which will pad items to 32 bytes, which will [prevent hash collisions](https://docs.soliditylang.org/en/v0.8.13/abi-spec.html#non-standard-packed-mode) (e.g. `abi.encodePacked(0x123,0x456)` => `0x123456` => `abi.encodePacked(0x1,0x23456)`, but `abi.encode(0x123,0x456)` => `0x0...1230...456`). Unless there is a compelling reason, `abi.encode` should be preferred. If there is only one argument to `abi.encodePacked()` it can often be cast to `bytes()` or `bytes32()` [instead](https://ethereum.stackexchange.com/questions/30912/how-to-compare-strings-in-solidity#answer-82739).
If all arguments are strings and or bytes, `bytes.concat()` should be used instead.

<details><summary>2 Found Instances</summary>


- Found in src/MoodNft.sol [Line: 106](src/MoodNft.sol#L106)

	```solidity
	            abi.encodePacked(
	```

- Found in src/MoodNft.sol [Line: 110](src/MoodNft.sol#L110)

	```solidity
	                        abi.encodePacked(
	```

</details>



## H-2: Functions send eth away from contract but performs no checks on any address.

Consider introducing checks for `msg.sender` to ensure the recipient of the money is as intended.

<details><summary>2 Found Instances</summary>


- Found in src/MNftPoolLockAndRelease.sol [Line: 189](src/MNftPoolLockAndRelease.sol#L189)

	```solidity
	    function withdraw(address _beneficiary) external onlyOwner {
	```

- Found in src/WMNftPoolMintAndBurn.sol [Line: 195](src/WMNftPoolMintAndBurn.sol#L195)

	```solidity
	    function withdraw(address _beneficiary) public onlyOwner {
	```

</details>



# Low Issues

## L-1: Centralization Risk for trusted owners

Contracts have owners with privileged rights to perform admin tasks and need to be trusted to not perform malicious updates or drain funds.

<details><summary>10 Found Instances</summary>


- Found in src/MNftPoolLockAndRelease.sol [Line: 127](src/MNftPoolLockAndRelease.sol#L127)

	```solidity
	    function allowlistDestinationChain(uint64 _destinationChainSelector, bool allowed) external onlyOwner {
	```

- Found in src/MNftPoolLockAndRelease.sol [Line: 137](src/MNftPoolLockAndRelease.sol#L137)

	```solidity
	    function allowlistSourceChain(uint64 _sourceChainSelector, bool allowed) external onlyOwner {
	```

- Found in src/MNftPoolLockAndRelease.sol [Line: 147](src/MNftPoolLockAndRelease.sol#L147)

	```solidity
	    function allowlistSender(address _sender, bool allowed) external onlyOwner {
	```

- Found in src/MNftPoolLockAndRelease.sol [Line: 189](src/MNftPoolLockAndRelease.sol#L189)

	```solidity
	    function withdraw(address _beneficiary) external onlyOwner {
	```

- Found in src/MNftPoolLockAndRelease.sol [Line: 209](src/MNftPoolLockAndRelease.sol#L209)

	```solidity
	    function withdrawToken(address _beneficiary, address _token) external onlyOwner {
	```

- Found in src/WMNftPoolMintAndBurn.sol [Line: 141](src/WMNftPoolMintAndBurn.sol#L141)

	```solidity
	    function allowlistDestinationChain(uint64 _destinationChainSelector, bool allowed) external onlyOwner {
	```

- Found in src/WMNftPoolMintAndBurn.sol [Line: 151](src/WMNftPoolMintAndBurn.sol#L151)

	```solidity
	    function allowlistSourceChain(uint64 _sourceChainSelector, bool allowed) external onlyOwner {
	```

- Found in src/WMNftPoolMintAndBurn.sol [Line: 161](src/WMNftPoolMintAndBurn.sol#L161)

	```solidity
	    function allowlistSender(address _sender, bool allowed) external onlyOwner {
	```

- Found in src/WMNftPoolMintAndBurn.sol [Line: 195](src/WMNftPoolMintAndBurn.sol#L195)

	```solidity
	    function withdraw(address _beneficiary) public onlyOwner {
	```

- Found in src/WMNftPoolMintAndBurn.sol [Line: 215](src/WMNftPoolMintAndBurn.sol#L215)

	```solidity
	    function withdrawToken(address _beneficiary, address _token) public onlyOwner {
	```

</details>



## L-2: Unsafe ERC20 Operations should not be used

ERC20 functions may not behave as expected. For example: return values are not always meaningful. It is recommended to use OpenZeppelin's SafeERC20 library.

<details><summary>2 Found Instances</summary>


- Found in src/MNftPoolLockAndRelease.sol [Line: 252](src/MNftPoolLockAndRelease.sol#L252)

	```solidity
	        s_linkToken.approve(address(router), fees);
	```

- Found in src/WMNftPoolMintAndBurn.sol [Line: 263](src/WMNftPoolMintAndBurn.sol#L263)

	```solidity
	        feeTokenAddress.approve(address(router), fees);
	```

</details>



## L-3: Missing checks for `address(0)` when assigning values to address state variables

Check for `address(0)` when assigning values to address state variables.

<details><summary>1 Found Instances</summary>


- Found in src/MNftPoolLockAndRelease.sol [Line: 105](src/MNftPoolLockAndRelease.sol#L105)

	```solidity
	        s_linkToken = IERC20(_link);
	```

</details>



## L-4: `public` functions not used internally could be marked `external`

Instead of marking a function as `public`, consider marking it as `external` if it is not used internally.

<details><summary>6 Found Instances</summary>


- Found in src/MoodNft.sol [Line: 96](src/MoodNft.sol#L96)

	```solidity
	    function tokenURI(uint256 tokenId) public view override returns (string memory) {
	```

- Found in src/WMNftPoolMintAndBurn.sol [Line: 195](src/WMNftPoolMintAndBurn.sol#L195)

	```solidity
	    function withdraw(address _beneficiary) public onlyOwner {
	```

- Found in src/WMNftPoolMintAndBurn.sol [Line: 215](src/WMNftPoolMintAndBurn.sol#L215)

	```solidity
	    function withdrawToken(address _beneficiary, address _token) public onlyOwner {
	```

- Found in src/WMNftPoolMintAndBurn.sol [Line: 335](src/WMNftPoolMintAndBurn.sol#L335)

	```solidity
	    function getLastReceivedMessageDetails() public view returns (bytes32 messageId, string memory text) {
	```

- Found in src/WMoodNft.sol [Line: 19](src/WMoodNft.sol#L19)

	```solidity
	    function mintNft() public override {
	```

- Found in src/WMoodNft.sol [Line: 35](src/WMoodNft.sol#L35)

	```solidity
	    function mintWithSpecificTokenId(address to, uint256 _tokenId) public {
	```

</details>



## L-5: Event is missing `indexed` fields

Index event fields make the field more quickly accessible to off-chain tools that parse events. However, note that each index field costs extra gas during emission, so it's not necessarily best to index the maximum allowed per event (three fields). Each event should use three indexed fields if there are three or more fields, and gas usage is not particularly of concern for the events in question. If there are fewer than three fields, all of the fields should be indexed.

<details><summary>3 Found Instances</summary>


- Found in src/MNftPoolLockAndRelease.sol [Line: 51](src/MNftPoolLockAndRelease.sol#L51)

	```solidity
	    event MessageSent(
	```

- Found in src/MoodNft.sol [Line: 33](src/MoodNft.sol#L33)

	```solidity
	    event FlippedMood(uint256 indexed tokenId, Mood mood);
	```

- Found in src/WMNftPoolMintAndBurn.sol [Line: 50](src/WMNftPoolMintAndBurn.sol#L50)

	```solidity
	    event MessageSent(
	```

</details>



## L-6: Modifiers invoked only once can be shoe-horned into the function



<details><summary>4 Found Instances</summary>


- Found in src/MNftPoolLockAndRelease.sol [Line: 83](src/MNftPoolLockAndRelease.sol#L83)

	```solidity
	    modifier onlyAllowlisted(uint64 _sourceChainSelector, address _sender) {
	```

- Found in src/WMNftPoolMintAndBurn.sol [Line: 70](src/WMNftPoolMintAndBurn.sol#L70)

	```solidity
	    modifier onlyAllowlistedDestinationChain(uint64 _destinationChainSelector) {
	```

- Found in src/WMNftPoolMintAndBurn.sol [Line: 82](src/WMNftPoolMintAndBurn.sol#L82)

	```solidity
	    modifier onlyAllowlisted(uint64 _sourceChainSelector, address _sender) {
	```

- Found in src/WMNftPoolMintAndBurn.sol [Line: 94](src/WMNftPoolMintAndBurn.sol#L94)

	```solidity
	    modifier validateReceiver(address _receiver) {
	```

</details>



## L-7: Large literal values multiples of 10000 can be replaced with scientific notation

Use `e` notation, for example: `1e18`, instead of its full numeric value.

<details><summary>2 Found Instances</summary>


- Found in src/MNftPoolLockAndRelease.sol [Line: 361](src/MNftPoolLockAndRelease.sol#L361)

	```solidity
	                    gasLimit: 400_000, // Gas limit for the callback on the destination chain
	```

- Found in src/WMNftPoolMintAndBurn.sol [Line: 316](src/WMNftPoolMintAndBurn.sol#L316)

	```solidity
	                    gasLimit: 400_000, // Gas limit for the callback on the destination chain
	```

</details>



## L-8: Internal functions called only once can be inlined

Instead of separating the logic into a separate function, consider inlining the logic into the calling function. This can reduce the number of function calls and improve readability.

<details><summary>3 Found Instances</summary>


- Found in src/MNftPoolLockAndRelease.sol [Line: 231](src/MNftPoolLockAndRelease.sol#L231)

	```solidity
	    function sendMessagePayLINK(uint64 _destinationChainSelector, address _receiver, bytes memory _data)
	```

- Found in src/MNftPoolLockAndRelease.sol [Line: 273](src/MNftPoolLockAndRelease.sol#L273)

	```solidity
	    function sendMessagePayNative(uint64 _destinationChainSelector, address _receiver, bytes memory _data)
	```

- Found in src/WMNftPoolMintAndBurn.sol [Line: 237](src/WMNftPoolMintAndBurn.sol#L237)

	```solidity
	    function sendMessagePay(
	```

</details>



## L-9: State variable changes but no event is emitted.

State variable changes in this function but no event is emitted.

<details><summary>9 Found Instances</summary>


- Found in src/MNftPoolLockAndRelease.sol [Line: 127](src/MNftPoolLockAndRelease.sol#L127)

	```solidity
	    function allowlistDestinationChain(uint64 _destinationChainSelector, bool allowed) external onlyOwner {
	```

- Found in src/MNftPoolLockAndRelease.sol [Line: 137](src/MNftPoolLockAndRelease.sol#L137)

	```solidity
	    function allowlistSourceChain(uint64 _sourceChainSelector, bool allowed) external onlyOwner {
	```

- Found in src/MNftPoolLockAndRelease.sol [Line: 147](src/MNftPoolLockAndRelease.sol#L147)

	```solidity
	    function allowlistSender(address _sender, bool allowed) external onlyOwner {
	```

- Found in src/MoodNft.sol [Line: 50](src/MoodNft.sol#L50)

	```solidity
	    function mintNft() external virtual {
	```

- Found in src/WMNftPoolMintAndBurn.sol [Line: 141](src/WMNftPoolMintAndBurn.sol#L141)

	```solidity
	    function allowlistDestinationChain(uint64 _destinationChainSelector, bool allowed) external onlyOwner {
	```

- Found in src/WMNftPoolMintAndBurn.sol [Line: 151](src/WMNftPoolMintAndBurn.sol#L151)

	```solidity
	    function allowlistSourceChain(uint64 _sourceChainSelector, bool allowed) external onlyOwner {
	```

- Found in src/WMNftPoolMintAndBurn.sol [Line: 161](src/WMNftPoolMintAndBurn.sol#L161)

	```solidity
	    function allowlistSender(address _sender, bool allowed) external onlyOwner {
	```

- Found in src/WMoodNft.sol [Line: 19](src/WMoodNft.sol#L19)

	```solidity
	    function mintNft() public override {
	```

- Found in src/WMoodNft.sol [Line: 35](src/WMoodNft.sol#L35)

	```solidity
	    function mintWithSpecificTokenId(address to, uint256 _tokenId) public {
	```

</details>



## L-10: State variable could be declared immutable

State variables that are should be declared immutable to save gas. Add the `immutable` attribute to state variables that are only changed in the constructor

<details><summary>3 Found Instances</summary>


- Found in src/MNftPoolLockAndRelease.sol [Line: 32](src/MNftPoolLockAndRelease.sol#L32)

	```solidity
	    IERC20 private s_linkToken;
	```

- Found in src/MoodNft.sol [Line: 24](src/MoodNft.sol#L24)

	```solidity
	    string private s_happySvgImageUri;
	```

- Found in src/MoodNft.sol [Line: 25](src/MoodNft.sol#L25)

	```solidity
	    string private s_sadSvgImageUri;
	```

</details>



## L-11: Return value of the function call is not checked.

Function returns a value but it is ignored.

<details><summary>1 Found Instances</summary>


- Found in src/WMNftPoolMintAndBurn.sol [Line: 182](src/WMNftPoolMintAndBurn.sol#L182)

	```solidity
	        sendMessagePay(destinationChainSelector, receiver, abi.encode(tokenId, newOwner), feeTokenAddress);
	```

</details>



